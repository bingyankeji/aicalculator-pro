# 🔗 分享功能配置说明

## 📋 功能概述

**分享功能** 允许用户通过URL链接分享他们的计算结果给朋友，支持：
- ✅ 直接复制链接
- ✅ Facebook 分享
- ✅ Twitter 分享  
- ✅ WhatsApp 分享
- ✅ Email 分享

**工作原理：**
1. 用户完成计算后，点击"Share"按钮
2. 系统生成包含计算参数的URL（如：`/bmi-calculator?w=70&h=170&a=30&g=m&u=metric`）
3. 好友访问链接时，计算器自动填充参数并显示结果
4. 好友可以修改参数，计算自己的结果

---

## ⚙️ 环境变量配置

### 1. 创建 `.env.local` 文件

在项目根目录创建 `.env.local` 文件（如果不存在）：

```bash
# 项目根目录
touch .env.local
```

### 2. 本地开发配置

在 `.env.local` 中添加：

```env
# 本地开发
NEXT_PUBLIC_BASE_URL=http://localhost:3000
```

### 3. 生产环境配置

部署到生产环境时，更新 `.env.local` 或在部署平台（Vercel/Netlify等）配置：

```env
# 生产环境（替换为你的实际域名）
NEXT_PUBLIC_BASE_URL=https://aicalculator.com
```

**常见部署平台配置：**

#### Vercel
1. 进入项目 Settings → Environment Variables
2. 添加变量：
   - Key: `NEXT_PUBLIC_BASE_URL`
   - Value: `https://yourdomain.com`

#### Netlify
1. 进入 Site settings → Environment variables
2. 添加变量：
   - Key: `NEXT_PUBLIC_BASE_URL`  
   - Value: `https://yourdomain.com`

---

## 🚀 如何使用

### **自动回退机制**

如果没有配置 `NEXT_PUBLIC_BASE_URL`，系统会自动使用当前页面的 `origin`：

```typescript
const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || window.location.origin;
```

**这意味着：**
- ✅ 本地开发不配置也能工作（自动使用 `http://localhost:3000`）
- ✅ 生产环境不配置也能工作（自动使用部署的域名）
- ✅ 配置后可以更精确控制（如CDN、多域名场景）

---

## 🎯 已实现的计算器

### ✅ BMI Calculator (`/bmi-calculator`)
**URL参数：**
- `w` - weight（体重）
- `h` - height（身高）
- `a` - age（年龄）
- `g` - gender（性别：`m` = 男，`f` = 女）
- `u` - unit（单位：`metric` = 公制，`imperial` = 英制）

**示例链接：**
```
http://localhost:3000/bmi-calculator?w=70&h=170&a=30&g=m&u=metric
```

### 📌 待实现（Mortgage Calculator）
需要为房贷计算器也添加分享功能，参考BMI的实现。

---

## 🧪 测试步骤

### 1. 本地测试
```bash
# 1. 启动开发服务器
npm run dev

# 2. 访问 http://localhost:3000/bmi-calculator

# 3. 填写数据并点击"Calculate BMI"

# 4. 点击"Share"按钮

# 5. 复制生成的链接，应该是：
#    http://localhost:3000/bmi-calculator?w=70&h=170&a=30&g=m&u=metric

# 6. 在新标签页打开链接，验证：
#    ✅ 计算器自动填充了数据
#    ✅ 自动显示了计算结果
```

### 2. 生产环境测试
```bash
# 1. 构建生产版本
npm run build

# 2. 启动生产服务器
npm start

# 3. 访问 http://localhost:3000

# 4. 重复上述测试步骤
```

---

## 📝 代码实现要点

### **URL参数加载（useEffect）**
```typescript
useEffect(() => {
  if (typeof window === 'undefined') return;
  
  const params = new URLSearchParams(window.location.search);
  const w = params.get('w');
  const h = params.get('h');
  // ... 读取其他参数

  if (w && h && a && g) {
    // 自动填充并计算
    setInputs(newInputs);
    setTimeout(() => {
      const result = calculateBMIFromInputs(newInputs);
      setResult(result);
    }, 100);
  }
}, []);
```

### **分享链接生成**
```typescript
const handleShare = () => {
  const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || window.location.origin;
  
  const params = new URLSearchParams({
    w: inputs.weight.toString(),
    h: inputs.height.toString(),
    a: inputs.age.toString(),
    g: inputs.gender === 'female' ? 'f' : 'm',
    u: inputs.unit,
  });
  
  const url = `${baseUrl}/bmi-calculator?${params.toString()}`;
  setShareUrl(url);
  setShowShareModal(true);
};
```

### **社交媒体分享**
```typescript
const handleSocialShare = (platform: 'facebook' | 'twitter' | 'whatsapp' | 'email') => {
  const text = `Check out my BMI: ${result?.bmi}`;
  const encodedUrl = encodeURIComponent(shareUrl);
  
  switch (platform) {
    case 'facebook':
      url = `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`;
      break;
    case 'twitter':
      url = `https://twitter.com/intent/tweet?text=${encodedText}&url=${encodedUrl}`;
      break;
    // ...
  }
  
  window.open(url, '_blank', 'width=600,height=400');
};
```

---

## 🔒 安全注意事项

1. **URL参数验证**
   - ✅ 已实现：`parseFloat()`、`parseInt()` 自动过滤无效输入
   - ✅ 已实现：计算前验证数据范围（年龄18-120，体重/身高>0）

2. **XSS防护**
   - ✅ 使用 `URLSearchParams` API（自动编码）
   - ✅ 社交分享使用 `encodeURIComponent()`

3. **数据隐私**
   - ℹ️ URL分享不涉及敏感数据（只有身高、体重、年龄、性别）
   - ℹ️ 不存储任何用户数据到服务器

---

## 📈 未来优化方向

### **短链接服务（可选）**
如果URL过长，可以考虑：
1. 使用Base64编码压缩参数
2. 集成第三方短链接服务（bit.ly）
3. 自建短链接服务（需要数据库）

### **二维码分享（可选）**
```typescript
import QRCode from 'qrcode';

const generateQRCode = async () => {
  const qr = await QRCode.toDataURL(shareUrl);
  // 显示二维码供扫描
};
```

### **社交媒体预览（Open Graph）**
已在页面SEO中配置，分享到Facebook/Twitter时会显示预览卡片。

---

## ❓ 常见问题

### Q1: 本地开发分享链接总是 `localhost`？
**A:** 这是正常的！本地开发就应该用 `localhost`。部署到生产后会自动使用正确的域名。

### Q2: 需要每次都配置环境变量吗？
**A:** 不需要。如果不配置，系统会自动使用当前域名。只在特殊场景（CDN、多域名）才需要手动配置。

### Q3: 分享的链接很长，可以缩短吗？
**A:** 可以！使用参数简写（如 `w` 代替 `weight`）已经缩短了URL。进一步缩短需要Base64编码或短链接服务。

### Q4: 如何给其他计算器添加分享功能？
**A:** 参考 `components/Calculator/BMICalculator.tsx` 的实现：
1. 添加 `handleShare` 函数（生成URL）
2. 添加 `useEffect`（读取URL参数）
3. 添加"Share"按钮和模态框UI

---

## 📞 技术支持

如有问题，请查看：
- 代码实现：`components/Calculator/BMICalculator.tsx`
- 标准模板：`功能开发清单.md`
- SEO配置：`app/bmi-calculator/page.tsx`

